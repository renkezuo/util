package com.renke.util.Browers;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class EBookDown {
	final static String BOOKNAME = "奥术神座";
	final static String SAVEPATH = "G:\\ebook\\"+BOOKNAME;
	final static String CATALOG_START = BOOKNAME+"无弹窗最新章节列表";
	final static String CATALOG_END = "书旗小说同类无弹窗阅读推荐";
	final static String CONTENT_START = BOOKNAME + "全文阅读";
	final static String CONTENT_END = BOOKNAME + "手机阅读";
	final static String CATALOG_PATH = "http://www.shuqi6.com/2486/";
	final static String CHAPTER_HREF = "href";
	final static String CHAPTER_TITLE = "title";
	final static String SOURCE_ENCODING = "GBK";
	final static String SAVE_ENCODING = "UTF-8";
	
	/**
	 * 读取url内容，将内容完全返回。
	 * @param urlPath
	 * @return
	 * @throws IOException
	 */
	public String accessResourse(String urlPath) throws IOException {
		URL url = new URL(urlPath);
		URLConnection uc = url.openConnection();
		uc.setRequestProperty("contentType",SOURCE_ENCODING);
		uc.connect();
		InputStream is = uc.getInputStream();
		BufferedReader in = new BufferedReader(new InputStreamReader(is, SOURCE_ENCODING));
		StringBuilder html = new StringBuilder();
		String line = "";
		while((line=in.readLine()) != null){
			String str = new String(line.getBytes(),SAVE_ENCODING);
			html.append(str);
		}
		in.close();
		is.close();
		return html.toString();
	}
	
	/**
	 * 通过urlPath读取到文件后，写入文件中，替换html标签
	 * @param urlPath
	 * @param title
	 * @return
	 */
	public int writeBookByUrl(String urlPath,String title){
		URL url;
		try {
			File file = new File(SAVEPATH+File.separator+urlPath.substring(urlPath.lastIndexOf("/")+1));
			if(!file.exists()) file.createNewFile();
			url = new URL(urlPath);
			URLConnection uc = url.openConnection();
			uc.setRequestProperty("contentType", SOURCE_ENCODING);
			uc.connect();
			InputStream is = uc.getInputStream();
			BufferedReader in = new BufferedReader(new InputStreamReader(is,SOURCE_ENCODING));
			BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
					new FileOutputStream(file)));
			String line = "";
			boolean start = false;
			boolean end = false;
			bw.write(title);
			bw.newLine();
			while((line=in.readLine()) != null){
				if(line.indexOf(CONTENT_END) > -1 ) end = true;
				if(end){
					break;
				}
				if(start){
					line = new String(line.getBytes(),SAVE_ENCODING);
					line = line.replaceAll("&nbsp;", " ").replaceAll("<.*?>","")
							.replaceAll("&lt;.*?&gt;", "").replaceAll("\\.","");
					if(!"".equals(line.trim())) {
						bw.write(line);
						bw.newLine();
					}
				}
				if(line.indexOf(CONTENT_START) > -1 ) start = true;
			}
			bw.flush();
			bw.close();
			in.close();
			is.close();
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			System.out.println(e.getMessage());
			return -1;
		} catch (IOException e) {
			// TODO Auto-generated catch block
			System.out.println(e.getMessage());
			return -2;
		}
		return 0;
	}
	
	/**
	 * 根据list读取数据
	 * 异常路径循环读取
	 * FIXME  可以考虑 设置异常次数，避免无限循环
	 * @param list
	 */
	public void writeControl(List<Map<String,String>> list){
		List<Map<String,String>> errorList = new ArrayList<Map<String,String>>();
		for(Map<String,String> m : list){
			int i = writeBookByUrl(CATALOG_PATH + m.get(CHAPTER_HREF),m.get(CHAPTER_TITLE));
			if(i<0) errorList.add(m);
		}
		if(errorList.size()>0){
			writeControl(errorList);
		}
	}
	
	/**
	 * 读取目录链接，返回
	 * @return {[href:章节链接,title:章节名称],[href:章节链接,title:章节名称]}
	 * @throws IOException
	 */
	public List<Map<String,String>> readCatalog() throws IOException{
		String html = accessResourse(CATALOG_PATH);
		File f = new File(SAVEPATH);
		if(!f.isDirectory()) f.mkdirs();
		//设置抓取头，和抓取尾[避免抓取错误的a标签]
		char[] chars = html.toCharArray();
		StringBuilder sb = new StringBuilder();
		boolean isBegin = false;
		boolean isEnd = false;
		boolean a = false;
		boolean href = false;
		boolean title = false;
		boolean semicolon = false;
		List<Map<String,String>> urlList = new ArrayList<Map<String,String>>();
		Map<String,String> map = null;
		for(char c : chars){
			sb.append(c);
			if(!isBegin&&sb.toString().endsWith(CATALOG_START)){
				sb.delete(0, sb.length());
				isBegin = true;
			}
			if(isBegin && !isEnd && sb.toString().endsWith(CATALOG_END)){
				break;
			}
			if(isBegin && sb.toString().endsWith("<a")){
				a = true;
				sb.delete(0, sb.length());
			}
			if(a && sb.toString().endsWith(CHAPTER_HREF)){
				href = true;
				sb.delete(0, sb.length());
			}
			if(a && href && !semicolon && sb.toString().endsWith("\"")){
				semicolon = true;
				sb.delete(0, sb.length());
			}
			if(a && href && semicolon && sb.toString().endsWith("\"")){
				map = new HashMap<String,String>();
				map.put(CHAPTER_HREF, sb.toString().replaceAll("\"",""));
				href = false;
				semicolon = false;
				sb.delete(0, sb.length());
			}
			if(a && sb.toString().endsWith(CHAPTER_TITLE)){
				title = true;
				sb.delete(0, sb.length());
			}
			if(a && title && !semicolon && sb.toString().endsWith("\"")){
				semicolon = true;
				sb.delete(0, sb.length());
			}
			if(a && title && semicolon && sb.toString().endsWith("\"")){
				map.put(CHAPTER_TITLE, sb.toString().replaceAll("\"",""));
				urlList.add(map);
				title = false;
				semicolon = false;
				a = false;
				sb.delete(0, sb.length());
			}
		}
		return urlList;
	}
	
	public void mergeFile(List<Map<String,String>> urlList) throws IOException{
		File file = new File(SAVEPATH+File.separator+BOOKNAME+".txt");
		if(!file.exists()) file.createNewFile();
		BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(file));
		byte[] buf = new byte[4096];
		for(Map<String,String> map : urlList){
			File chapter = new File(SAVEPATH+File.separator+map.get(CHAPTER_HREF));
			BufferedInputStream bis = new BufferedInputStream(new FileInputStream(chapter));
			int len = 0;
			while((len = bis.read(buf))!=-1){
				bos.write(buf, 0, len);
			}
			bis.close();
		}
		bos.flush();
		bos.close();
	}
	
	public void clearSpaceLine() throws IOException{
		File inFile = new File(SAVEPATH+File.separator+BOOKNAME+".txt");
		File outFile = new File(SAVEPATH+File.separator+BOOKNAME+"2.txt");
		BufferedReader in = new BufferedReader(new InputStreamReader(new FileInputStream(inFile)));
		BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(outFile)));
		String line = "";
		while((line = in.readLine())!=null){
			if(!"".equals(line.trim())){
				bw.write(line);
				bw.newLine();
			}
		}
		in.close();
		bw.close();
//		inFile.delete();
//		outFile.renameTo(inFile);
		
	}
	
	
	public static void main(String[] args) {
		EBookDown ed = new EBookDown();
		try {
			List<Map<String,String>> urlList = ed.readCatalog();
			ed.writeControl(urlList);
			ed.mergeFile(urlList);
			
//			ed.clearSpaceLine();
//			测试成功			
//			File file = new File("G:\\ebook\\test.txt");
//			File file2 = new File("G:\\ebook\\test2.txt");
//			file.delete();
//			file2.renameTo(file);
//			throw new IOException("测试用的");
			/**
			 * 考虑使用多线程的方式实现888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
			 */
			
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		/**
		 * 
		 * 1、找到书籍的目录页面
		 * 2、设置抓取头，和抓取尾[避免抓取错误的a标签]
		 * 3、抓取目录页面的a标签
		 * 4、取到a标签中的href
		 * 5、对href内容抓取[如果href内容非正式的连接，则直接将href内容，加到目录连接后]
		 * 6、抓取到网页内容后，[同样设置抓取头和抓取尾]
		 * 使用10个线程  一起抓取
		 * 最后整合到一个文件中
		 * 
		 * 7、www.shuqi6.com抓取规则简单说明
		 * 		目录页面头：bookname+"无弹窗最新章节列表"
		 * 		目录页面尾："同类无弹窗阅读推荐"
		 * 		章节名称取a标签的title
		 * 		文章开头：bookname + "全文阅读"
		 * 		文章结尾：bookname+"手机阅读"
		 */
	}
	
	
	
	final class WriteBookByURL implements Runnable{
		String urlPath;
		String title;
		public WriteBookByURL(String urlPath,String title){
			this.urlPath = urlPath;
			this.title = title;
		}
		
		@Override
		public void run() {
			URL url;
			try {
				File file = new File(SAVEPATH+File.separator+urlPath.substring(urlPath.lastIndexOf("/")));
				if(!file.exists()) file.createNewFile();
				url = new URL(urlPath);
				URLConnection uc = url.openConnection();
				uc.setRequestProperty("contentType", "GBK");
				uc.connect();
				InputStream is = uc.getInputStream();
				BufferedReader in = new BufferedReader(new InputStreamReader(is, "GBK"));
				BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
						new FileOutputStream(file)));
				String line = "";
				boolean start = false;
				boolean end = false;
				bw.write(title);
				bw.newLine();
				while((line=in.readLine()) != null){
					if(line.indexOf(CONTENT_END) > -1 ) end = true;
					if(end){
						break;
					}
					if(start){
						if(!"".equals(line.trim())) {
							bw.write(line.replaceAll("&nbsp;", " ").replaceAll("<.*?>",""));
							bw.newLine();
						}
					}
					if(line.indexOf(CONTENT_START) > -1 ) start = true;
				}
				bw.flush();
				bw.close();
				in.close();
				is.close();
			} catch (MalformedURLException e) {
				System.out.println(e.getMessage());
				return ;
			} catch (IOException e) {
				System.out.println(e.getMessage());
				return ;
			}
		}
		
	}
}